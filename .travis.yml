version: ~> 1.0
dist: focal
# this arch is required as is for Partner Queue Solution - DO NOT MODIFY
arch: ppc64le

language: java
sudo: false

# until https://github.com/checkstyle/contribution/issues/534
# install:
#   - gem install mdl

matrix:
  fast_finish: true
  include:
    # until https://github.com/checkstyle/contribution/issues/534
    # - jdk: openjdk8
    #   env:
    #     - DESC="markdown lint"
    #     - CMD="./.ci/travis.sh markdownlint"

    - jdk: openjdk8
      env:
        - DESC="releasenotes-builder"
        - CMD="./.ci/travis.sh releasenotes-builder"

    - jdk: openjdk8
      env:
        - DESC="patch-diff-report-tool"
        - CMD="./.ci/travis.sh patch-diff-report-tool"

    - jdk: openjdk8
      arch: amd64
      dist: xenial
      env:
        - DESC="checkstyle-tester (diff.groovy) on linux"
        - CMD="./.ci/travis.sh checkstyle-tester-diff-groovy-patch"

    - jdk: openjdk8
      arch: amd64
      dist: xenial
      env:
        - DESC="checkstyle-tester (diff.groovy) on linux with base and patch configs"
        - CMD="./.ci/travis.sh checkstyle-tester-diff-groovy-base-patch"

    - jdk: openjdk8
      arch: amd64
      dist: xenial
      env:
        - DESC="checkstyle-tester (diff.groovy) on linux with enabled patchOnly"
        - CMD="./.ci/travis.sh checkstyle-tester-diff-groovy-patch-only"

    # disabled till https://github.com/checkstyle/contribution/issues/448
    # - jdk: openjdk8
    #   env:
    #     - DESC="codenarc validation for groovy files"
    #     - CMD="./.ci/travis.sh codenarc"

addons:
  apt:
    packages:
      - xmlstarlet
      - ruby
      - groovy

before_script:
    - |
      if [[ $TRAVIS_CPU_ARCH == 'ppc64le' ]]; then
          export JAVA_HOME=/usr/lib/jvm/adoptopenjdk-8-hotspot-ppc64el
          export PATH=$JAVA_HOME/bin:$PATH
      fi
    - groovy --version

script:
  - |
    set -e
    MVN_SETTINGS=${TRAVIS_HOME}/.m2/settings.xml
    if [[ -f ${MVN_SETTINGS} ]]; then
      if [[ $TRAVIS_OS_NAME == 'osx' ]]; then
        sed -i'' -e "/<mirrors>/,/<\/mirrors>/ d" $MVN_SETTINGS
      else
        xmlstarlet ed --inplace -d "//mirrors" $MVN_SETTINGS
      fi
    fi
  - |
    set -e
    eval $CMD

after_success:

cache:
  directories:
  - ~/.m2

branches:
  only:
    - master
